<configuration>

  <!-- LOCAL: human-friendly -->
  <springProfile name="local, default">
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
      <encoder>
        <!-- Include trace & span from MDC -->
        <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - [%X{traceId:-} %X{spanId:-}] %msg%n</pattern>
      </encoder>
    </appender>
    <root level="INFO"><appender-ref ref="CONSOLE"/></root>
  </springProfile>

  <!-- DEV/PROD: JSON + async -->
  <springProfile name="dev,prod">
    <appender name="JSON_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
      <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
        <providers>
          <timestamp/>
          <logLevel/>
          <threadName/>
          <loggerName/>
          <message/>
          <mdc/>        <!-- includes traceId/spanId -->
          <stackTrace/>
        </providers>
      </encoder>
    </appender>

    <appender name="ASYNC_JSON" class="ch.qos.logback.classic.AsyncAppender">
      <queueSize>8192</queueSize>
      <discardingThreshold>0</discardingThreshold>
      <appender-ref ref="JSON_CONSOLE"/>
    </appender>

    <root level="INFO"><appender-ref ref="ASYNC_JSON"/></root>
  </springProfile>

</configuration>
